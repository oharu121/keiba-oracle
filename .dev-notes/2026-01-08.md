# 2026-01-08 Dev Notes

## Fixed TypeScript Errors in CopilotKit Integration

### Error 1: Missing `@copilotkit/runtime` module

**File:** `web/app/api/copilotkit/route.ts:6`

**Error:**
```
Cannot find module '@copilotkit/runtime' or its corresponding type declarations.
```

**Cause:** The `@copilotkit/runtime` package was imported but not listed in `package.json` dependencies.

**Fix:** Added `"@copilotkit/runtime": "^1.50.0"` to `web/package.json` dependencies.

---

### Error 2: `isLoading` property does not exist on `useCoAgent`

**File:** `web/hooks/useKeibaOracle.ts:31`

**Error:**
```
Property 'isLoading' does not exist on type 'UseCoagentReturnType<OracleState>'.
```

**Cause:** The CopilotKit `useCoAgent` hook returns `running` (boolean), not `isLoading`. The API was incorrectly assumed.

**Fix:**
1. Changed destructuring from `isLoading` to `running`:
   ```ts
   const { state, setState, run, running } = useCoAgent<OracleState>({...})
   ```
2. Mapped `running` to `isLoading` in the return object to maintain the hook's external API:
   ```ts
   return {
     isLoading: running,
     // ...
   }
   ```

**Reference:** The correct `useCoAgent` return type from `@copilotkit/react-core`:
```ts
interface UseCoagentReturnType<T> {
  name: string;
  nodeName?: string;
  threadId?: string;
  running: boolean;  // <-- not isLoading
  state: T;
  setState: (newState: T | ((prevState: T | undefined) => T)) => void;
  start: () => void;
  stop: () => void;
  run: (...args: any[]) => Promise<any>;
}
```

---

## Fixed Python Type Errors in Gemini API Response Handling

### Errors in auditor.py, scout.py, strategist.py

**Issue:** `response.candidates` and `candidate.content.parts` can be `None`, causing type errors when iterating.

**Fix:** Added null checks before iteration:
```python
for candidate in response.candidates or []:
    if candidate.content is None or candidate.content.parts is None:
        continue
    for part in candidate.content.parts:
        ...
```

Also fixed `func_call.name` which can be `str | None` in scout.py:
```python
func_name = func_call.name
if func_name is None:
    continue
```

---

## Added Comprehensive Test Suite

### Backend Tests (agent/tests/)

**Framework:** pytest with pytest-asyncio

**Files created:**
- `tests/__init__.py` - Package marker
- `tests/conftest.py` - Shared fixtures (mock Gemini, Tavily, state fixtures)
- `tests/test_models.py` - Pydantic model validation tests
- `tests/test_scout.py` - Scout node unit tests
- `tests/test_strategist.py` - Strategist node unit tests
- `tests/test_auditor.py` - Auditor node unit tests

**Run with:** `cd agent && uv run pytest`

### Frontend Tests (web/)

**Framework:** Vitest with @testing-library/react

**Files created:**
- `vitest.config.ts` - Vitest configuration
- `tests/setup.ts` - Global test setup (framer-motion mock)
- `tests/mocks/copilotkit.ts` - CopilotKit useCoAgent mock
- `hooks/__tests__/useKeibaOracle.test.ts` - Hook unit tests

**Run with:** `cd web && npm install && npm test`
