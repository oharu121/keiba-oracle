# Dev Notes: 2026-01-11

## CopilotKit Vercel Deployment - The Long Journey

Today we finally resolved the persistent "Agent not found" runtime error on Vercel after
a multi-day debugging journey. Here's the complete story of what we discovered.

---

## The Original Error

```
Uncaught Error: useAgent: Agent 'default' not found after runtime sync
(runtimeUrl=/api/copilotkit). No agents registered.
```

This error prevented the Keiba Oracle frontend from connecting to the LangGraph backend
hosted on HuggingFace Spaces.

---

## Issue 1: Missing `dict_repr()` Method

**Symptom:** Backend `/copilotkit/info` endpoint returning 500 error

**Root Cause:** CopilotKit Python SDK's `LangGraphAGUIAgent` class was missing a
`dict_repr()` method that the SDK's info endpoint expected.

**Upstream Bug:** [CopilotKit#2891](https://github.com/CopilotKit/CopilotKit/issues/2891)

**Fix:** Created `PatchedLangGraphAGUIAgent` subclass in `agent/app/main.py`:

```python
class PatchedLangGraphAGUIAgent(LangGraphAGUIAgent):
    """Patched agent class that adds missing dict_repr method."""

    def dict_repr(self):
        return {
            "name": self.name,
            "description": self.description or "",
        }
```

**Version:** Fixed in v0.2.1

---

## Issue 2: Trailing Slash Requirement

**Symptom:** Backend works when tested directly, but frontend gets empty response

**Root Cause:** CopilotKit's `add_fastapi_endpoint` registers routes as `/{prefix}/{path:path}`,
which means:
- `/copilotkit/` works (path="" matches)
- `/copilotkit` returns 404 (no route match)

FastAPI's default `redirect_slashes=True` sends a 307 redirect, but CopilotKit's runtime
doesn't follow redirects for POST requests.

**Upstream Bug:** [CopilotKit#1907](https://github.com/CopilotKit/CopilotKit/issues/1907)

**Fix:** AGENT_URL must include trailing slash:
```
AGENT_URL=https://oharu121-keiba-oracle.hf.space/copilotkit/
```

**Version:** Documented in v0.2.2, v0.2.3

---

## Issue 3: `remoteEndpoints` Returns Empty Agents

**Symptom:** Backend returns agents correctly, but Vercel frontend shows `{"agents":{}}`

**Root Cause:** CopilotKit v1.50.0's `CopilotRuntime.assignEndpointsToAgents()` method
always returns an empty object for basic `CopilotKitEndpoint` type. The `remoteEndpoints`
configuration is accepted but **does not actually create agents**.

From `node_modules/@copilotkit/runtime/src/lib/runtime/copilot-runtime.ts`:
```typescript
private assignEndpointsToAgents(...): Record<string, AbstractAgent> {
  let result: Record<string, AbstractAgent> = {};
  // ... LangGraphPlatformEndpoint throws deprecation error
  return result;  // <-- ALWAYS RETURNS EMPTY FOR CopilotKitEndpoint!
}
```

**Fix:** Switch from `remoteEndpoints` to `LangGraphAgent` with explicit `agents` config:

```typescript
// Before (broken)
const runtime = new CopilotRuntime({
  remoteEndpoints: [{ url: agentUrl }],
});

// After (working)
import { LangGraphAgent } from "@copilotkit/runtime/langgraph";

const runtime = new CopilotRuntime({
  agents: {
    "keiba-oracle": new LangGraphAgent({
      deploymentUrl: agentUrl,
      graphId: "keiba_oracle",
    }),
  },
});
```

**Version:** Fixed in v0.2.4

---

## Issue 4: CopilotKit Provider Default Agent

**Symptom:** After Issue 3 fix, error changed to:
```
Agent 'default' not found ... Known agents: [keiba-oracle]
```

This was progress! Agents were now being registered, but something was looking for "default".

**Root Cause:** The `<CopilotKit>` React provider defaults the `agent` prop to `"default"`:

```typescript
// node_modules/@copilotkit/react-core/src/components/copilot-provider/copilotkit.tsx:531
<CopilotChatConfigurationProvider agentId={props.agent ?? "default"} ...>
```

When using `useCoAgent()` or internal hooks, they fall back to `DEFAULT_AGENT_ID = "default"`
from `@copilotkitnext/shared`.

**Fix:** Add `agent` prop to match our registered agent name:

```tsx
// Before (broken)
<CopilotKit runtimeUrl="/api/copilotkit">

// After (working)
<CopilotKit runtimeUrl="/api/copilotkit" agent="keiba-oracle">
```

**Version:** Fixed in v0.2.4

---

## Summary of All Fixes

| Issue | Root Cause | Fix | Version |
|-------|------------|-----|---------|
| 1 | Missing `dict_repr()` in Python SDK | `PatchedLangGraphAGUIAgent` subclass | v0.2.1 |
| 2 | FastAPI route pattern needs trailing slash | AGENT_URL ends with `/` | v0.2.2 |
| 3 | `remoteEndpoints` doesn't register agents | Use `LangGraphAgent` with `agents` config | v0.2.4 |
| 4 | CopilotKit defaults to "default" agent | Add `agent="keiba-oracle"` prop | v0.2.4 |

---

## Key Learnings

1. **CopilotKit is still evolving** - The SDK has several undocumented behaviors and bugs
   that require workarounds. Always check GitHub issues for similar problems.

2. **Debug endpoints are invaluable** - Adding a GET endpoint to check configuration helped
   verify that environment variables were correctly set in Vercel.

3. **Read the source code** - When documentation is lacking, diving into `node_modules`
   revealed the exact issues (like the `assignEndpointsToAgents` returning empty object).

4. **Error messages evolve** - The error changing from "No agents registered" to
   "Known agents: [keiba-oracle]" was a crucial signal that we were making progress.

5. **Multiple issues can compound** - This wasn't a single bug but four separate issues
   that all had to be fixed for the integration to work.

---

## Files Modified

- `agent/app/main.py` - PatchedLangGraphAGUIAgent
- `web/app/api/copilotkit/route.ts` - LangGraphAgent configuration
- `web/app/layout.tsx` - agent prop on CopilotKit provider
- `web/.env.local.example` - Trailing slash documentation
- `.issues/001-copilotkit-dict-repr-bug.md` - Issue documentation
- `.issues/002-copilotkit-default-agent.md` - Issue documentation
- `.plans/002-copilotkit-vercel-fix.md` - Plan documentation
- `CHANGELOG.md` - Release notes

---

## Versions

- copilotkit Python SDK: 0.1.74
- @copilotkit/runtime: ^1.50.0
- @copilotkit/react-core: ^1.50.0
- @copilotkitnext/react: 0.0.33
