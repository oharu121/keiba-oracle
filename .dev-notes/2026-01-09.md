# 2026-01-09 Dev Notes

## Hugging Face Spaces Deployment

### Added Dockerfile for HF Spaces

Created `agent/Dockerfile` for deploying backend to Hugging Face Spaces:

```dockerfile
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

RUN pip install --no-cache-dir uv

# README.md is required by pyproject.toml for hatchling build
COPY pyproject.toml uv.lock README.md ./

RUN uv sync --frozen --no-dev

COPY app/ ./app/

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"

CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**Key points:**
- Uses `uv sync --frozen --no-dev` to install from lock file without dev dependencies
- Must copy `README.md` before `uv sync` because `pyproject.toml` references it for hatchling build
- HF Spaces YAML header in `agent/README.md` specifies `sdk: docker` and `app_port: 8000`

---

### Build Error: Missing README.md

**Error:**
```
OSError: Readme file does not exist: README.md
```

**Cause:** The `.dockerignore` had `*.md` which excluded README.md before `uv sync` could run.

**Fix:** Changed `.dockerignore` from wildcard exclusion to explicit file list:
```
# Before (broken)
*.md
!README.md

# After (works)
CHANGELOG.md
CONTRIBUTING.md
docs/
```

Also updated Dockerfile to explicitly copy README.md:
```dockerfile
COPY pyproject.toml uv.lock README.md ./
```

---

### Runtime Error: LangGraphAgent Deprecated

**Error:**
```
ValueError: LangGraphAgent should be instantiated using LangGraphAGUIAgent.
Refer to https://docs.copilotkit.ai/langgraph for more information.
```

**Cause:** CopilotKit 0.1.74 deprecated `LangGraphAgent` in favor of `LangGraphAGUIAgent`.

**Fix in `agent/app/main.py`:**

```python
# Before
from copilotkit import CopilotKitSDK, LangGraphAgent

sdk = CopilotKitSDK(
    agents=[
        LangGraphAgent(
            name="keiba-oracle",
            ...
        )
    ]
)

# After
from copilotkit import CopilotKitSDK, LangGraphAGUIAgent

sdk = CopilotKitSDK(
    agents=[
        LangGraphAGUIAgent(
            name="keiba-oracle",
            ...
        )
    ]
)
```

**Note:** Both classes exist in copilotkit 0.1.74, but `LangGraphAgent` now raises an error directing users to use `LangGraphAGUIAgent` for AG-UI protocol support.

---

### CORS Configuration for Vercel Frontend

Added Vercel production domain to CORS allowed origins:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "http://127.0.0.1:3000",
        "https://keiba-oracle.vercel.app",  # Added for production
    ],
    ...
)
```

---

## Required HF Spaces Secrets

Set these in HF Spaces Settings > Repository secrets:
- `GOOGLE_API_KEY` - Gemini API key
- `TAVILY_API_KEY` - Tavily search API key
